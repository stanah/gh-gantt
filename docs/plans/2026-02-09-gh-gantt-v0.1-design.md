# gh-gantt v0.1 機能要件設計

## プロダクトの位置づけ

**gh-gantt** は、GitHub ProjectsのIssueをローカルJSONと双方向同期し、**階層的な進捗の全体像を掴む**ためのOSSツール。gh CLI extension として提供する。

### 差別化ポイント

- **完全ローカル + OSS**: SaaS依存なし。データ主権がユーザーの手元にある
- **深い双方向同期**: Issue body、Sub Issues、カスタムフィールドまで含む本格的な同期

### 主要ユーザー

GitHub Projectsを使うチーム。セットアップは開発者が行い、非開発者もブラウザUIでアクセスする。

### 対象範囲

単一ProjectV2。ただしProjectV2が複数リポジトリのIssueを含む場合に対応する。データモデルは複数リポジトリ横断を最初から想定する。

---

## メイン画面: ツリー + ガント一体型ビュー

左ペインにタスクツリー、右ペインにガントタイムライン。中央の境界はドラッグでリサイズ可能。

### 左ペイン（タスクツリー）

- parent/sub_tasks に基づく階層ツリー表示
- 各行に: タスクタイトル、type アイコン/色、進捗率バー、色付きステータスバッジ
- 折りたたみ/展開トグル
- typeフィルタ（Epicだけ表示、Task+Bugだけ表示 等）

### 右ペイン（ガントタイムライン）

- 時間軸ヘッダー（日/週/月切替）
- type.display に応じた3種描画:
  - `bar`: 通常タスクの水平バー
  - `summary`: 括弧型バー（子タスクの期間から自動算出）
  - `milestone`: ◆ダイヤモンド（単一日付）
- blocked_by の接続矢印（FS/FF/SS/SF 4種）
- 今日線（赤い縦線）
- 非稼働日グレーアウト（working_days設定）
- マウスホイールまたはツールバーでズーム

---

## ステータス設定

GitHub ProjectsのカスタムStatusフィールドに対応する。

### gantt.config.json での定義

```json
{
  "statuses": {
    "field_name": "Status",
    "values": {
      "Backlog":     { "color": "#95A5A6", "done": false },
      "Todo":        { "color": "#3498DB", "done": false },
      "In Progress": { "color": "#F39C12", "done": false },
      "Done":        { "color": "#2ECC71", "done": true }
    }
  }
}
```

- `field_name`: ProjectV2のStatusフィールド名（カスタム名に対応）
- `values`: 各ステータスの色と完了フラグ
- `init` 時にProjectV2のStatus選択肢を自動取得して初期生成

### ツリー上の表示

- 各タスク行のタイトル横に色付きステータスバッジを表示
- ガントバーの色は task_type に紐づく（ステータス色と混在しない）

---

## 進捗率

Issue の state および Status の `done` フラグに基づく自動算出。手動入力なし。

- **末端タスク**: Issue が closed、または Status が `done: true` なら 100%。それ以外は 0%
- **親タスク**: 完了子数 / 全子数 x 100%（再帰的に算出）
- 進捗率は保存せず、表示時にランタイム算出する

---

## UIからの編集操作

### 編集可能フィールド

| フィールド | 操作方法 | 同期先 |
|---|---|---|
| state | ツリー行のチェックボックス or バッジクリック | Issue open/close |
| Status | バッジクリックでドロップダウン | ProjectV2 Status フィールド |
| title | ツリー行のインライン編集 | Issue title |
| body | サイドパネルで Markdown 編集 | Issue body |
| assignees | サイドパネルで選択 | Issue assignees |
| labels | サイドパネルで選択 | Issue labels |
| 親子関係 | サイドパネルで親の変更 / 子の追加・削除 | Sub Issues API |
| start_date / end_date | ガントバーのドラッグ（移動）+ 左右端リサイズ | ProjectV2 Date フィールド（あれば） |

### 編集フロー

1. UIで編集 → tasks.json に即時書き込み
2. ユーザーが明示的に `push`（UIのボタン or CLI）で GitHub に反映
3. push 前に `status` 相当の差分プレビューを表示

### サイドパネル（TaskDetailPanel）

タスクをダブルクリックで開く。以下を表示・編集:

- タイトル、body（Markdownレンダリング + 編集）
- state、Status、assignees、labels、milestone
- type選択
- 日付ピッカー（start_date / end_date）
- blocked_by / blocking 一覧
- parent / sub_tasks 一覧
- linked PRs（ステータス付き、読み取り専用）
- コメント一覧（キャッシュ、読み取り専用）
- GitHub Issueへの直リンク

---

## CLIコマンド

gh CLI extension として提供。リポジトリ名: `gh-gantt`

| コマンド | 機能 |
|---|---|
| `gh gantt init` | ProjectV2から初期データ取得。config/tasks/sync-state生成 |
| `gh gantt pull` | GitHub → ローカル。リモート変更を取り込む |
| `gh gantt push` | ローカル → GitHub。編集内容を書き戻す |
| `gh gantt serve` | ブラウザUI起動。UIからの編集はtasks.jsonに書き込み |
| `gh gantt status` | ローカルとリモートの差分プレビュー |

### init

```bash
gh gantt init --owner stanah --repo my-repo --project 1
```

1. `gh auth token` でトークン取得
2. ProjectV2 GraphQL APIでProject情報・全アイテム・全Issue詳細（body含む）取得
3. Sub Issues APIで親子関係取得
4. ラベルからtype自動判別
5. Statusフィールドの選択肢を自動取得 → statuses設定を初期生成
6. `.gantt-sync/gantt.config.json`, `tasks.json`, `sync-state.json` を生成
7. カスタムフィールドのマッピングを自動検出

### serve

```bash
gh gantt serve                   # localhost:3000 でUI起動
gh gantt serve --port 8080
gh gantt serve --sync-on-start   # 起動時に自動pull
```

### pull / push

```bash
gh gantt pull                    # GitHub → Local
gh gantt pull --force            # GitHub側で上書き

gh gantt push                    # Local → GitHub
gh gantt push --dry-run          # 変更プレビュー
gh gantt push --create-issues    # ローカル専用タスクをIssue化
```

### status

```bash
gh gantt status
```

---

## 同期設計

### 方針

- `pull` と `push` は別コマンド。`sync`（双方向自動同期）はv0.1では提供しない
- コンフリクト（同一フィールドに双方変更あり）は検出して警告表示。自動解決はしない
- serve中の同期は手動トリガー（UIのボタンまたはCLI）

### 差分検出

1. ローカルの各タスク: sync-state.jsonのスナップショットハッシュと現在値を比較
2. リモートの各アイテム: GraphQL APIで最新取得 → スナップショットハッシュと比較
3. 同一タスク・同一フィールドに双方変更 → conflict（警告表示）
4. 片方のみ変更 → 変更側を採用
5. リモートのみに存在 → new_remote（tasks.jsonに追加）
6. ローカルのみに存在(github_issue != null) → deleted_remote（要確認）

### フィールド同期区分

| フィールド | 同期方向 | 備考 |
|---|---|---|
| title | 双方向 | |
| body | 双方向 | Issue本文 |
| state, state_reason | 双方向 | |
| assignees | 双方向 | |
| labels | 双方向 | type判別にも利用 |
| milestone | 双方向 | |
| custom_fields (Status等) | 双方向 | ProjectV2フィールド |
| parent, sub_tasks | 双方向 | Sub Issues APIと同期 |
| start_date, end_date | ローカルのみ※ | ※ProjectV2にDateフィールドがあれば双方向 |
| linked_prs | GitHub → ローカル | 自動検出、読み取り専用 |
| created_at, updated_at, closed_at | GitHub → ローカル | 読み取り専用 |
| blocked_by | ローカルのみ | GitHub側に対応なし |
| type | ローカル管理 | github_labelで自動判別可 |
| cache (comments, reactions) | GitHub → ローカル | 読み取りキャッシュ |

---

## データモデルの変更点（元設計からの差分）

### 削除

- `tasks.json` の `progress` フィールド → state + Status の done フラグで自動算出（ランタイム計算）
- 進捗率ドラッグUI → 不要

### 追加

- `gantt.config.json` に `statuses` セクション
- 複数リポジトリ対応のため `github_repo` フィールドをタスクに追加（`"owner/repo"` 形式）

### コマンド名変更

- `gantt-sync` → `gh gantt`（gh extension）
- リポジトリ名: `gh-gantt`

---

## v0.1 スコープ外（将来フェーズ）

| 機能 | 理由 |
|---|---|
| `gh gantt sync`（双方向自動同期） | コンフリクト自動解決が複雑 |
| クリティカルパス計算 | 後のフェーズ |
| WebSocketリアルタイム通信 | serve中は手動トリガーで十分 |
| TUI | ブラウザUI優先 |
| サマリーダッシュボード | 後のフェーズ |
| ResourceView / MiniMap | 後のフェーズ |
| 仮想スクロール | タスク数が多くなってから |
| SVG/PNG エクスポート | 後のフェーズ |
| Undo/Redo | 後のフェーズ |
